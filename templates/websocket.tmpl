// ============================================================================
// AUTO-GENERATED by ANG (Architectural Normalized Generator)
// Version: {{ ANGVersion }}
// InputHash: {{ InputHash }}
// CompilerHash: {{ CompilerHash }}
// DO NOT EDIT - changes will be overwritten on next generation
// GENERATED: true
// ============================================================================

package http

import (
	"encoding/json"
	"net/http"

	"github.com/go-chi/chi/v5"
	{{- if .HasBroadcast }}
	"{{GoModule}}/internal/domain"
	{{- end }}
	"{{GoModule}}/internal/port"
)

var {{ .Name | ToLower }}Hub = &wsHub{
	rooms:      make(map[string]map[*wsClient]bool),
	broadcast:  make(chan wsMessage, 1024),
	register:   make(chan *wsClient),
	unregister: make(chan *wsClient),
	stop:       make(chan struct{}),
}

func init() {
	go {{ .Name | ToLower }}Hub.run()
}

func Stop{{ .Name }}Hub() {
	{{ .Name | ToLower }}Hub.stop <- struct{}{}
}

// Broadcast{{ .Name }}WS sends a message to all connected clients in a room.
func Broadcast{{ .Name }}WS(roomID string, messageType string, payload interface{}) {
	msg := wsBroadcast{Type: messageType, Payload: payload}
	data, err := json.Marshal(msg)
	if err != nil {
		return
	}
	{{ .Name | ToLower }}Hub.broadcast <- wsMessage{room: roomID, data: data}
}

{{- $uniqueMessages := makeMap }}

{{- range .Endpoints }}

{{- range .Messages }}

{{- if not (mapHas $uniqueMessages .) }}

{{- mapSet $uniqueMessages . true }}

func Broadcast{{ . }}({{ if $.HasRooms }}roomID string, {{ end }}payload domain.{{ ExportName . }}) {

	Broadcast{{ $.Name }}WS({{ if $.HasRooms }}roomID{{ else }}""{{ end }}, "{{ . }}", payload)

}

{{- end }}

{{- end }}

{{- end }}



func Register{{ .Name }}WSRoutes(r chi.Router, svc port.{{ .Name }}) {
{{- range .Endpoints }}
	{{- $mw := WSMiddlewareList . }}
	{{- if $mw }}
	r.With({{ $mw }}).
		Get("{{ .Path }}", handler{{ .RPC }}WS(svc))
	{{- else }}
	r.Get("{{ .Path }}", handler{{ .RPC }}WS(svc))
	{{- end }}
{{- end }}
}

{{- range .Endpoints }}
func handler{{ .RPC }}WS(svc port.{{ $.Name }}) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		{{- $ep := . }}
		{{- $hasParams := false }}
		{{- if .Input.Name }}
		{{- range .Input.Fields }}
		{{- $param := ParamForField $ep.Path .Name }}
		{{- if ne $param "" }}
		{{- $hasParams = true }}
		{{- end }}
		{{- end }}
		{{- end }}
		{{- if $hasParams }}
		var req port.{{ .Input.Name }}
		{{- range .Input.Fields }}
		{{- $param := ParamForField $ep.Path .Name }}
		{{- if ne $param "" }}
		req.{{ .Name | ExportName }} = chi.URLParam(r, "{{ $param }}")
		{{- end }}
		{{- end }}
		_ = req // silence unused warning if no params extracted
		{{- end }}
		{{- if .AuthCheck }}
		{{- $ep := . }}
		var authReq port.{{ .AuthCheck }}Request
		{{- range .Input.Fields }}
		{{- $param := ParamForField $ep.Path .Name }}
		{{- if ne $param "" }}
		authReq.{{ .Name | ExportName }} = chi.URLParam(r, "{{ $param }}")
		{{- end }}
		{{- end }}
		{{- if .AuthCheckHasCompanyID }}
		authReq.CompanyId = CurrentCompanyID(r)
		{{- end }}
		authResp, err := svc.{{ .AuthCheck }}(r.Context(), authReq)
		if err != nil {
			http.Error(w, "access check failed", http.StatusInternalServerError)
			return
		}
		if !authResp.Allowed {
			http.Error(w, "forbidden", http.StatusForbidden)
			return
		}
		{{- end }}
		conn, err := wsUpgrader.Upgrade(w, r, nil)
		if err != nil {
			return
		}

		// Auth happens post-upgrade: client sends { type: "auth", token: "<jwt>" } as first message.
		// This keeps JWT out of the URL (access logs, browser history, Referer headers).
		{{- $needsUserID := false }}
		{{- if .RoomParam }}
		{{- $roomParam := ParamForField .Path .RoomParam }}
		{{- if and (not $roomParam) (stringsEqualFold .RoomParam "userId") }}
		{{- $needsUserID = true }}
		{{- end }}
		{{- else if HasInputField .Input "userId" }}
		{{- $needsUserID = true }}
		{{- end }}
		{{- if $needsUserID }}
		wsUserID, _, wsAuthErr := wsReadAuthTokenOrQuery(conn, r)
		{{- else }}
		_, _, wsAuthErr := wsReadAuthTokenOrQuery(conn, r)
		{{- end }}
		if wsAuthErr != nil {
			return
		}

		roomID := ""
		{{- if .RoomParam }}
		{{- $roomParam := ParamForField .Path .RoomParam }}
		{{- if $roomParam }}
		roomID = chi.URLParam(r, "{{ $roomParam }}")
		{{- else if stringsEqualFold .RoomParam "userId" }}
		roomID = wsUserID
		{{- end }}
		{{- else if HasInputField .Input "userId" }}
		roomID = wsUserID
		{{- end }}

		client := &wsClient{hub: {{ $.Name | ToLower }}Hub, conn: conn, send: make(chan []byte, 256), room: roomID}
		client.hub.register <- client

		go client.writePump()
		go client.readPump()
	}
}
{{- end }}
