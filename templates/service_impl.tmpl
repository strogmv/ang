package service

import (
	"context"
	"github.com/strog/dealingi-back/internal/port"
)

type {{ .Service.Name }}Impl struct {
	{{- range getRepoEntities .Service .Entities }}
	{{ ExportName . }}Repo port.{{ ExportName . }}Repository
	{{- end }}
	{{- range getServiceDeps .Service }}
	{{ ExportName . }}Service port.{{ ExportName . }}
	{{- end }}
	{{- if ServiceNeedsTx .Service }}
	txManager port.TxManager
	{{- end }}
	auditService port.Audit
}

func New{{ .Service.Name }}Impl(
	{{- range getRepoEntities .Service .Entities }}
	{{ ExportName . | lowerFirst }}Repo port.{{ ExportName . }}Repository,
	{{- end }}
	{{- range getServiceDeps .Service }}
	{{ ExportName . | lowerFirst }}Service port.{{ ExportName . }},
	{{- end }}
	{{- if ServiceNeedsTx .Service }}
	txManager port.TxManager,
	{{- end }}
	extra ...any,
) *{{ .Service.Name }}Impl {
	var auditSvc port.Audit
	for _, arg := range extra {
		if a, ok := arg.(port.Audit); ok {
			auditSvc = a
		}
	}
	return &{{ .Service.Name }}Impl{
		{{- range getRepoEntities .Service .Entities }}
		{{ ExportName . }}Repo: {{ ExportName . | lowerFirst }}Repo,
		{{- end }}
		{{- range getServiceDeps .Service }}
		{{ ExportName . }}Service: {{ ExportName . | lowerFirst }}Service,
		{{- end }}
		{{- if ServiceNeedsTx .Service }}
		txManager: txManager,
		{{- end }}
		auditService: auditSvc,
	}
}

{{- range .Service.Methods }}
{{ if not (mapHas $.Overrides .Name) }}
func (s *{{ $.Service.Name }}Impl) {{ .Name }}(ctx context.Context, req port.{{ .Input.Name }}) (resp port.{{ .Output.Name }}, err error) {
	return resp, nil
}
{{- end }}
{{- end }}
