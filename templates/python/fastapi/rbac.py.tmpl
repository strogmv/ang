"""RBAC dependency helpers generated by ANG."""

from __future__ import annotations

from fastapi import HTTPException, Request

ROLE_PERMISSIONS: dict[str, set[str]] = {
{{- if .Roles }}
{{- range $role, $perms := .Roles }}
    "{{ $role }}": {
{{- range $p := $perms }}
        "{{ $p }}",
{{- end }}
    },
{{- end }}
{{- end }}
}


def _request_permissions(request: Request) -> set[str]:
    raw = request.headers.get("X-Permissions", "")
    if not raw:
        return set()
    return {p.strip() for p in raw.split(",") if p.strip()}


def require_permission(permission: str):
    def _dependency(request: Request) -> None:
        perms = _request_permissions(request)
        if permission not in perms:
            raise HTTPException(status_code=403, detail="forbidden")

    return _dependency
