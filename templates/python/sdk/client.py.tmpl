"""Python SDK generated by ANG."""

from __future__ import annotations

from typing import Any, Callable

import httpx


class AngClient:
    def __init__(
        self,
        base_url: str,
        token: str | None = None,
        timeout: float = 10.0,
        client: httpx.Client | None = None,
        token_provider: Callable[[], str | None] | None = None,
    ) -> None:
        self._base_url = base_url.rstrip("/")
        self._token = token
        self._token_provider = token_provider
        self._client = client or httpx.Client(base_url=self._base_url, timeout=timeout)

    def close(self) -> None:
        self._client.close()

    def set_token(self, token: str | None) -> None:
        self._token = token

    def set_token_provider(self, provider: Callable[[], str | None] | None) -> None:
        self._token_provider = provider

    def _resolve_token(self) -> str | None:
        if self._token_provider is not None:
            value = self._token_provider()
            if value:
                return str(value)
        return self._token

    def _headers(self) -> dict[str, str]:
        headers: dict[str, str] = {"Accept": "application/json"}
        token = self._resolve_token()
        if token:
            headers["Authorization"] = f"Bearer {token}"
        return headers
{{ range .Endpoints }}

    def {{ .MethodName }}(self{{ if .PathParams }}, {{ JoinTypedParams .PathParams }}{{ end }}{{ if .HasBody }}, payload: dict[str, Any] | None = None{{ end }}) -> Any:
        response = self._client.request(
            "{{ .Method }}",
            f"{{ PathWithFormat .Path }}",
            headers=self._headers(),{{ if .HasBody }}
            json=payload,{{ end }}
        )
        response.raise_for_status()
        if not response.content:
            return None
        return response.json()
{{ end }}
