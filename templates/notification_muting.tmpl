package adapter

import (
	"context"
	"strings"
	{{- if .IncludeTime }}
	"time"
	{{- end }}

	"{{ GoModule }}/internal/domain"
	"{{ GoModule }}/internal/port"
)

// MutingNotificationRepo is a decorator around NotificationRepository that
// silently skips Save when the target user has muted the notification type.
// Generated by ANG â€” do not edit.
type MutingNotificationRepo struct {
	inner    port.NotificationRepository
	userRepo port.UserRepository
}

// NewMutingNotificationRepo wraps the real notification repo with mute checks.
func NewMutingNotificationRepo(inner port.NotificationRepository, userRepo port.UserRepository) *MutingNotificationRepo {
	return &MutingNotificationRepo{inner: inner, userRepo: userRepo}
}

// Save checks user mute settings before delegating to the inner repository.
func (r *MutingNotificationRepo) Save(ctx context.Context, entity *domain.Notification) error {
	if entity != nil && entity.UserID != "" {
		user, err := r.userRepo.FindByID(ctx, entity.UserID)
		if err == nil && IsNotificationMuted(user, entity.Type) {
			return nil
		}
	}
	return r.inner.Save(ctx, entity)
}

// IsNotificationMuted checks whether notification type is muted for a user.
func IsNotificationMuted(user *domain.User, notificationType string) bool {
	if user == nil {
		return false
	}
	if user.{{ MuteAllField }} {
		return true
	}
	muteType := strings.TrimSpace(notificationType)
	if muteType == "" {
		return false
	}
	for _, t := range user.{{ MutedTypesField }} {
		if strings.EqualFold(strings.TrimSpace(t), muteType) {
			return true
		}
	}
	return false
}

// FindByID delegates to the inner repository.
func (r *MutingNotificationRepo) FindByID(ctx context.Context, id string) (*domain.Notification, error) {
	return r.inner.FindByID(ctx, id)
}

// Delete delegates to the inner repository.
func (r *MutingNotificationRepo) Delete(ctx context.Context, id string) error {
	return r.inner.Delete(ctx, id)
}

// ListAll delegates to the inner repository.
func (r *MutingNotificationRepo) ListAll(ctx context.Context, offset, limit int) ([]domain.Notification, error) {
	return r.inner.ListAll(ctx, offset, limit)
}
{{ range .ExtraFinders }}
// {{ .Name }} delegates to the inner repository.
func (r *MutingNotificationRepo) {{ .Name }}(ctx context.Context{{ if .ParamsSig }}, {{ .ParamsSig }}{{ end }}) ({{ .ReturnType }}, error) {
	return r.inner.{{ .Name }}(ctx{{ if .ArgNames }}, {{ .ArgNames }}{{ end }})
}
{{ end }}
