{{ define "main_server_root" }}
// ============================================================================
// AUTO-GENERATED by ANG (Architectural Normalized Generator)
// Template: main_server/*
// DO NOT EDIT - changes will be overwritten on next generation
// ============================================================================
{{- if eq (len .Header.ServicesIR) 0 }}{{ fail "No services defined - check cue/api/*.cue" }}{{ end }}

// ============================================================================
// AUTO-GENERATED by ANG (Architectural Normalized Generator)
// Version: {{ .Header.ANGVersion }}
// InputHash: {{ .Header.InputHash }}
// CompilerHash: {{ .Header.CompilerHash }}
// DO NOT EDIT - changes will be overwritten on next generation
// GENERATED: true
// ============================================================================

package main

{{ template "main_server_imports" .Imports }}

func main() {
	log := logger.Init()
	log.Info("Starting application...")
	ctx := context.Background()

	cfg, err := config.Load()
	if err != nil {
		log.Error("Failed to load config", "error", err)
		os.Exit(1)
	}
	if err := transport.SetAuthConfigFromConfig(cfg); err != nil {
		log.Error("Failed to init auth", "error", err)
		os.Exit(1)
	}

	tp, err := tracing.Init("ang-service")
	if err != nil {
		log.Error("Failed to init tracing", "error", err)
	} else {
		log.Info("Tracing initialized")
		defer func() {
			if err := tp.Shutdown(ctx); err != nil {
				log.Error("Tracing shutdown failed", "error", err)
			}
		}()
	}

	{{ template "main_server_infrastructure" .Infrastructure }}
	{{ template "main_server_http_router" .HTTPRouter }}
	{{ template "main_server_repositories" .Repositories }}
	{{ template "main_server_services" .Services }}
	{{ template "main_server_websockets" .WebSockets }}

	// Health & Readiness probes
	r.Get("/health", transport.HealthHandler())
	r.Get("/health/ready", transport.ReadinessHandler(pgPool, redisClient, natsClient))
	r.Handle("/metrics", promhttp.Handler())

	{{ template "main_server_graceful_shutdown" .GracefulShutdown }}
}
{{ end }}
