// Package http provides HTTP handlers for the service.
// ============================================================================
// AUTO-GENERATED by ANG (Architectural Normalized Generator)
// Version: {{ ANGVersion }}
// InputHash: {{ InputHash }}
// CompilerHash: {{ CompilerHash }}
// DO NOT EDIT - changes will be overwritten on next generation
// GENERATED: true
// ============================================================================

package http

import (
	"encoding/json"
	"net/http"
	{{- if .HasETag }}
	"crypto/sha256"
	"fmt"
	{{- end }}
	{{- if .HasQueryParse }}
	"strconv"
	{{- end }}

	"github.com/go-chi/chi/v5"
	"{{GoModule}}/internal/pkg/errors"
	{{- if .HasViews }}
	"{{GoModule}}/internal/pkg/views"
	{{- end }}
	{{- if or .HasBroadcast .HasDomainUsage }}
	"{{GoModule}}/internal/domain"
	{{- end }}
	"{{GoModule}}/internal/port"
)

func Register{{ .Name }}Routes(r chi.Router, svc port.{{ .Name }}) {
{{- range .Endpoints }}
	{{- $mw := MiddlewareList .Endpoint }}
	{{- if $mw }}
	r.With({{ $mw }}).{{ .Method | ToLower | ExportName }}("{{ .Path }}", handler{{ .RPC }}(svc))
	{{- else }}
	r.{{ .Method | ToLower | ExportName }}("{{ .Path }}", handler{{ .RPC }}(svc))
	{{- end }}
{{- end }}
}

{{- range .Endpoints }}
// handler{{ .RPC }}
{{- if .Source }}
// Source: {{ .Source }}
{{- end }}
func handler{{ .RPC }}(svc port.{{ $.Name }}) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		{{- if .Input.Name }}
		{{- $ep := . }}
		var req port.{{ .Input.Name }}
		{{- if eq .Method "GET" }}
		{{- range .Input.Fields }}
		{{- $fname := .Name | ToLower }}
		{{- if eq .Type "int" }}
		if v := r.URL.Query().Get("{{ $fname }}"); v != "" {
			if i, err := strconv.Atoi(v); err == nil {
				req.{{ .Name | ExportName }} = i
			} else {
				errors.WriteError(w, r, errors.NewValidationError("Invalid query", map[string]string{"{{ $fname }}": "must be integer"}))
				return
			}
		}
		{{- else if eq .Type "float64" }}
		if v := r.URL.Query().Get("{{ $fname }}"); v != "" {
			if f, err := strconv.ParseFloat(v, 64); err == nil {
				req.{{ .Name | ExportName }} = f
			} else {
				errors.WriteError(w, r, errors.NewValidationError("Invalid query", map[string]string{"{{ $fname }}": "must be number"}))
				return
			}
		}
		{{- else if eq .Type "bool" }}
		if v := r.URL.Query().Get("{{ $fname }}"); v != "" {
			if b, err := strconv.ParseBool(v); err == nil {
				req.{{ .Name | ExportName }} = b
			} else {
				errors.WriteError(w, r, errors.NewValidationError("Invalid query", map[string]string{"{{ $fname }}": "must be boolean"}))
				return
			}
		}
		{{- else }}
		if v := r.URL.Query().Get("{{ $fname }}"); v != "" {
			req.{{ .Name | ExportName }} = v
		}
		{{- end }}
		{{- end }}
		{{- else }}
		{{- if .HasBodyField }}
		if err := decodeJSONRequest(r, &req.Body); err != nil {
			errors.WriteError(w, r, errors.NewValidationError("Invalid JSON", map[string]string{"body": err.Error()}))
			return
		}
		{{- else }}
		if err := decodeJSONRequest(r, &req); err != nil {
			errors.WriteError(w, r, errors.NewValidationError("Invalid JSON", map[string]string{"body": err.Error()}))
			return
		}
		{{- end }}
		{{- end }}
		{{- range .Input.Fields }}
		{{- $param := ParamForField $ep.Path .Name }}
		{{- if ne $param "" }}
		{{- if eq .Type "int" }}
		if v := chi.URLParam(r, "{{ $param }}"); v != "" {
			if i, err := strconv.Atoi(v); err == nil {
				req.{{ .Name | ExportName }} = i
			} else {
				errors.WriteError(w, r, errors.NewValidationError("Invalid path", map[string]string{"{{ $param }}": "must be integer"}))
				return
			}
		}
		{{- else if eq .Type "float64" }}
		if v := chi.URLParam(r, "{{ $param }}"); v != "" {
			if f, err := strconv.ParseFloat(v, 64); err == nil {
				req.{{ .Name | ExportName }} = f
			} else {
				errors.WriteError(w, r, errors.NewValidationError("Invalid path", map[string]string{"{{ $param }}": "must be number"}))
				return
			}
		}
		{{- else if eq .Type "bool" }}
		if v := chi.URLParam(r, "{{ $param }}"); v != "" {
			if b, err := strconv.ParseBool(v); err == nil {
				req.{{ .Name | ExportName }} = b
			} else {
				errors.WriteError(w, r, errors.NewValidationError("Invalid path", map[string]string{"{{ $param }}": "must be boolean"}))
				return
			}
		}
		{{- else }}
		if v := chi.URLParam(r, "{{ $param }}"); v != "" {
			req.{{ .Name | ExportName }} = v
		}
		{{- end }}
		{{- end }}
		{{- end }}
		{{- range .AuthInject }}
		{{- if eq . "userId" }}
		if req.UserID == "" {
			req.UserID = CurrentUserID(r)
		}
		{{- else if eq . "companyId" }}
		if req.CompanyID == "" {
			req.CompanyID = CurrentCompanyID(r)
		}
		{{- end }}
		{{- end }}
		if err := validate.Struct(&req); err != nil {
			errors.WriteError(w, r, errors.NewValidationError(err.Error(), nil))
			return
		}
		if err := req.Validate(); err != nil {
			errors.WriteError(w, r, errors.NewValidationError(err.Error(), nil))
			return
		}
		{{- else }}
		// No input required
		{{- end }}

		{{- if .AuthCheck }}
		{{- $ep := . }}
		var authReq port.{{ .AuthCheck }}Request
		{{- range .Input.Fields }}
		{{- $param := ParamForField $ep.Path .Name }}
		{{- if ne $param "" }}
		authReq.{{ .Name | ExportName }} = chi.URLParam(r, "{{ $param }}")
		{{- end }}
		{{- end }}
		{{- if .AuthCheckHasCompanyID }}
		authReq.CompanyID = CurrentCompanyID(r)
		{{- end }}
		authResp, err := svc.{{ .AuthCheck }}(r.Context(), authReq)
		if err != nil {
			errors.WriteError(w, r, err)
			return
		}
		if !authResp.Allowed {
			errors.WriteError(w, r, errors.New(http.StatusForbidden, "Forbidden", "Insufficient access"))
			return
		}
		{{- end }}

		{{ if .Output.Name }}resp, {{ end }}err := svc.{{ .RPC }}(r.Context(), {{ if .Input.Name }}req{{ end }})
		if err != nil {
			errors.WriteError(w, r, err)
			return
		}
		{{- $hasRedirect := false }}
		{{- if .Input.Name }}
		{{- range .Input.Fields }}
		{{- if eq .Name "redirect" }}
		{{- $hasRedirect = true }}
		{{- end }}
		{{- end }}
		{{- end }}
		{{- $hasRedirectURL := false }}
		{{- if .Output.Name }}
		{{- range .Output.Fields }}
		{{- if eq .Name "redirectUrl" }}
		{{- $hasRedirectURL = true }}
		{{- end }}
		{{- end }}
		{{- end }}
		{{- if and $hasRedirect $hasRedirectURL }}
		if req.Redirect && resp.RedirectUrl != "" {
			http.Redirect(w, r, resp.RedirectUrl, http.StatusFound)
			return
		}
		{{- end }}
		{{- if .Broadcasts }}
		{{- $ep := . }}
		{{- if .Input.Name }}
		if data, err := json.Marshal(req); err == nil {
			{{- range .Broadcasts }}
			var ev{{ .Name }} domain.{{ ExportName .Name }}
			if err := json.Unmarshal(data, &ev{{ .Name }}); err == nil {
				{{- if $ep.RoomField }}
				Broadcast{{ .Name }}(req.{{ $ep.RoomField }}, ev{{ .Name }})
				{{- else }}
				Broadcast{{ .Name }}(ev{{ .Name }})
				{{- end }}
			}
			{{- end }}
		}
		{{- else if .Output.Name }}
		if data, err := json.Marshal(resp); err == nil {
			{{- range .Broadcasts }}
			var ev{{ .Name }} domain.{{ ExportName .Name }}
			if err := json.Unmarshal(data, &ev{{ .Name }}); err == nil {
				{{- if $ep.RoomField }}
				Broadcast{{ .Name }}(req.{{ $ep.RoomField }}, ev{{ .Name }})
				{{- else }}
				Broadcast{{ .Name }}(ev{{ .Name }})
				{{- end }}
			}
			{{- end }}
		}
		{{- end }}
		{{- end }}

		{{ if .Output.Name }}
		w.Header().Set("Content-Type", "application/json")
		{{- if eq .Method "GET" }}
		var out any
		{{- if .View }}
		out = views.ApplyView(CurrentRole(r), "{{ .View }}", resp)
		{{- else }}
		out = resp
		{{- end }}
		data, err := json.Marshal(out)
		if err != nil {
			errors.WriteError(w, r, errors.New(http.StatusInternalServerError, "Internal Server Error", "Failed to encode response"))
			return
		}
		{{- if $.HasETag }}
		etag := fmt.Sprintf("W/\"%x\"", sha256.Sum256(data))
		w.Header().Set("ETag", etag)
		if match := r.Header.Get("If-None-Match"); match == etag {
			w.WriteHeader(http.StatusNotModified)
			return
		}
		{{- end }}
		_, _ = w.Write(data)
		{{- else }}
		{{- if .View }}
		out := views.ApplyView(CurrentRole(r), "{{ .View }}", resp)
		_ = json.NewEncoder(w).Encode(out)
		{{- else }}
		_ = json.NewEncoder(w).Encode(resp)
		{{- end }}
		{{- end }}
		{{ else }}
		w.WriteHeader(http.StatusNoContent)
		{{ end }}
	}
}
{{- end }}
