// AUTO-GENERATED by ANG
import { apiClient, validateResponse } from './api-client';
import { markStoresListStale } from './stores/invalidation';
import * as Types from './types';

{{- range .Endpoints }}
{{- if ne .Method "WS" }}
{{- $argList := PathArgNames .Path }}
export const {{ LowerFirst .RPC }} = (params: Types.{{ .RPC }}Request = {} as Types.{{ .RPC }}Request) => {
  {{- if gt (len $argList) 0 }}
  // @ts-ignore
  {{- range $argList }}
  {{- if eq . (JSONName .) }}
  const {{ . }} = (params as any)?.{{ . }};
  {{- else }}
  const {{ . }} = (params as any)?.{{ . }} ?? (params as any)?.{{ JSONName . }};
  {{- end }}
  {{- end }}
  {{- end }}
  {{- if eq .Method "GET" }}
  const queryParams = { ...params } as any;
  {{- range $argList }}
  delete queryParams.{{ . }};
  {{- if ne . (JSONName .) }}
  delete queryParams.{{ JSONName . }};
  {{- end }}
  {{- end }}
  return apiClient.get<Types.{{ .RPC }}Response>(`{{ PathTemplate .Path }}`, { params: queryParams }).then((r) =>
    validateResponse('{{ .RPC }}ResponseSchema', r.data, '{{ .RPC }}')
  );
  {{- else if eq .Method "DELETE" }}
  return apiClient.delete<Types.{{ .RPC }}Response>(`{{ PathTemplate .Path }}`, { data: params }).then((r) => {
    const data = validateResponse('{{ .RPC }}ResponseSchema', r.data, '{{ .RPC }}');
    {{- $stores := MutationInvalidateStores . }}
    {{- if gt (len $stores) 0 }}
    const storesToInvalidate = endpointMeta.{{ LowerFirst .RPC }}.invalidateStores || [];
    if (storesToInvalidate.length > 0) {
      markStoresListStale(storesToInvalidate);
    }
    {{- end }}
    return data;
  });
  {{- else }}
  return apiClient.{{ .Method | ToLower }}<Types.{{ .RPC }}Response>(`{{ PathTemplate .Path }}`, params).then((r) => {
    const data = validateResponse('{{ .RPC }}ResponseSchema', r.data, '{{ .RPC }}');
    {{- $stores := MutationInvalidateStores . }}
    {{- if gt (len $stores) 0 }}
    const storesToInvalidate = endpointMeta.{{ LowerFirst .RPC }}.invalidateStores || [];
    if (storesToInvalidate.length > 0) {
      markStoresListStale(storesToInvalidate);
    }
    {{- end }}
    return data;
  });
  {{- end }}
};

{{- end }}
{{- end }}

export const endpointMeta: Record<string, {
  method: string;
  path: string;
  idempotent?: boolean;
  timeout?: string;
  authRoles?: string[];
  cacheTTL?: string;
  requiredHeaders?: string[];
  invalidateStores?: string[];
}> = {
{{- range .Endpoints }}
{{- if ne .Method "WS" }}
  {{- $policy := EndpointPolicy . }}
  {{ LowerFirst .RPC }}: {
    method: '{{ .Method }}',
    path: '{{ .Path }}',
    {{- if $policy.Idempotency }}
    idempotent: true,
    {{- end }}
    {{- if $policy.Timeout }}
    timeout: '{{ $policy.Timeout }}',
    {{- end }}
    {{- if $policy.AuthRoles }}
    authRoles: [{{- range $i, $r := $policy.AuthRoles }}{{ if $i }}, {{ end }}'{{ $r }}'{{- end }}],
    {{- end }}
    {{- if $policy.CacheTTL }}
    cacheTTL: '{{ $policy.CacheTTL }}',
    {{- end }}
    {{- if $policy.Validation.RequiredHeaders }}
    requiredHeaders: [{{- range $i, $h := $policy.Validation.RequiredHeaders }}{{ if $i }}, {{ end }}'{{ $h }}'{{- end }}],
    {{- end }}
    {{- $stores := MutationInvalidateStores . }}
    {{- if gt (len $stores) 0 }}
    invalidateStores: [{{- range $i, $s := $stores }}{{ if $i }}, {{ end }}'{{ $s }}'{{- end }}],
    {{- end }}
  },
{{- end }}
{{- end }}
};
