{{ define "main_server_services" }}
	svcAudit := service.NewAuditImpl(repoAuditLog)

	{{- range .ServicesIR }}
		{{- $svc := . }}
		{{- if ne .Name "Audit" }}
	svc{{ .Name }} := service.New{{ .Name }}Impl(
		{{- range getRepoEntitiesIR . $.EntitiesIR }}
		repo{{ ExportName . }},
		{{- end }}
		{{- range getServiceDepsIR . }}
		svc{{ ExportName . }},
		{{- end }}
		{{- if ServiceNeedsTxIR . }}
		txManager,
		{{- end }}
		{{- if and $.AuthService (eq $.AuthService .Name) }}
		cfg,
		refreshStore,
		{{- end }}
		{{- if ServiceHasPublishesIR . }}
		natsClient,
		{{- end }}
		{{- if ServiceHasIdempotencyIR . }}
			{{- if $.HasSQL }}
		repoSystem,
			{{- else }}
		nil,
			{{- end }}
		{{- end }}
		{{- if ServiceHasOutboxIR . }}
			{{- if $.HasSQL }}
		repoSystem,
			{{- else }}
		nil,
			{{- end }}
		{{- end }}
		svcAudit,
		{{- if .RequiresS3 }}
		s3Client,
		{{- end }}
		{{- if and $.HasNotificationsService (or (stringsEqualFold .Name "Notifications") (stringsEqualFold .Name "Notification")) }}
		notificationDispatcher,
		{{- end }}
	)
		{{- end }}

	{{ if $svc.Subscribes }}
	if natsClient != nil {
	{{- range $evtName := sortedKeys $svc.Subscribes }}
	{{- $method := mapGet $svc.Subscribes $evtName }}
		if _, err := natsClient.Subscribe("{{ $evtName }}", func(data []byte) error {
			var event port.{{ $method }}Request
			if err := json.Unmarshal(data, &event); err != nil {
				return err
			}
			if _, err := svc{{ $svc.Name }}.{{ $method }}(context.Background(), event); err != nil {
				return err
			}
			return nil
		}); err != nil {
			log.Error("Failed to subscribe to {{ $evtName }}", "error", err)
		}
	{{- end }}
	}
	{{ end }}

	transport.Register{{ .Name }}Routes(r, svc{{ .Name }})
	{{- if index $.WebSocketServices .Name }}
	transport.Register{{ .Name }}WSRoutes(r, svc{{ .Name }})
	{{- end }}
{{- end }}
{{ end }}
