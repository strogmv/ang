// Generated by ANG. Do not edit.
import { useQueryClient } from '@tanstack/react-query';
import { WebSocketClient, WSMessage } from '../websocket';
// @ts-ignore
import { useEffect } from 'react';

// Singleton WS Client
export const wsClient = new WebSocketClient(((import.meta as any).env?.VITE_API_URL || 'http://localhost:8080').replace(/^http/, 'ws') + '/ws');

/**
 * Hook to subscribe to specific WebSocket events.
 * @param topic The event type to filter by
 * @param onMessage Callback function when message arrives
 */
export const useWebsocketSubscription = <K extends WSMessage['type']>(
  topic: K, 
  onMessage: (payload: Extract<WSMessage, { type: K }>['payload']) => void
) => {
  const queryClient = useQueryClient();

  useEffect(() => {
    const unsubscribe = wsClient.subscribe((data: WSMessage) => {
      if (data.type === topic) {
        // @ts-ignore
        onMessage(data.payload);
      }
    });
    return () => unsubscribe();
  }, [topic, queryClient]);
};

/**
 * Global hook to automatically invalidate queries based on WS events.
 * Call this once in your App root.
 */
export const useAutoInvalidation = () => {
  const queryClient = useQueryClient();

  useEffect(() => {
    const unsubscribe = wsClient.subscribe((data: WSMessage) => {
      // Automatic invalidation logic
      // In Task 2 we will make this more sophisticated using metadata
      const entity = data.type.replace(/Placed|Updated|Created|Deleted|Finished|Started/g, '');
      if (entity) {
        queryClient.invalidateQueries({ queryKey: [entity] });
      }
    });
    return () => unsubscribe();
  }, [queryClient]);
};
