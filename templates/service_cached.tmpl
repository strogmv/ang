// ============================================================================
// AUTO-GENERATED by ANG (Architectural Normalized Generator)
// Version: {{ ANGVersion }}
// InputHash: {{ InputHash }}
// CompilerHash: {{ CompilerHash }}
// DO NOT EDIT - changes will be overwritten on next generation
// GENERATED: true
// ============================================================================

package service

import (
	"context"
	"encoding/json"
	"fmt"
	"time"

	"github.com/redis/go-redis/v9"
	"{{GoModule}}/internal/port"
)

// Blank identifiers to suppress unused import warnings
var (
	_ = json.Marshal
	_ = fmt.Sprintf
	_ = time.Now
)

// {{ .Name }}Cached decorates {{ .Name }} with Redis caching.
type {{ .Name }}Cached struct {
	next  port.{{ .Name }}
	redis *redis.Client
}

func New{{ .Name }}Cached(next port.{{ .Name }}, r *redis.Client) *{{ .Name }}Cached {
	return &{{ .Name }}Cached{
		next:  next,
		redis: r,
	}
}

{{- range .Methods }}
{{- if .Output.Name }}
func (s *{{ $.Name }}Cached) {{ .Name }}(ctx context.Context, req port.{{ .Input.Name }}) (port.{{ .Output.Name }}, error) {
	{{- if .CacheTTL }}
	// Cache Key: Simple hashing based on request
	key := fmt.Sprintf("cache:{{ $.Name }}:{{ .Name }}:%v", req)
	
	// 1. Try Cache
	val, err := s.redis.Get(ctx, key).Result()
	if err == nil {
		var resp port.{{ .Output.Name }}
		if err := json.Unmarshal([]byte(val), &resp); err == nil {
			return resp, nil
		}
	}

	// 2. Call Next
	resp, err := s.next.{{ .Name }}(ctx, req)
	if err != nil {
		return resp, err
	}

	// 3. Set Cache
	if data, err := json.Marshal(resp); err == nil {
		// Parsing duration at runtime for simplicity
		ttl, _ := time.ParseDuration("{{ .CacheTTL }}")
		s.redis.Set(ctx, key, data, ttl)
	}

	return resp, nil
	{{- else }}
	return s.next.{{ .Name }}(ctx, req)
	{{- end }}
}
{{- else }}
func (s *{{ $.Name }}Cached) {{ .Name }}(ctx context.Context, req domain.{{ ExportName .Input.Name }}) error {
	// Events are usually not cached in this layer
	return s.next.{{ .Name }}(ctx, req)
}
{{- end }}
{{- end }}
