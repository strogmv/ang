// AUTO-GENERATED by ANG
import { apiClient, validateResponse } from './api-client';
import { markInvalidateTargets } from './stores/invalidation';
import * as Types from './types';

{{- range .Endpoints }}
{{- if ne .Method "WS" }}
{{- $argList := PathArgNames .Path }}
export const {{ LowerFirst .RPC }} = (params: Types.{{ .RPC }}Request = {} as Types.{{ .RPC }}Request) => {
  {{- if gt (len $argList) 0 }}
  // @ts-ignore
  {{- range $argList }}
  {{- if eq . (JSONName .) }}
  const {{ . }} = (params as any)?.{{ . }};
  {{- else }}
  const {{ . }} = (params as any)?.{{ . }} ?? (params as any)?.{{ JSONName . }};
  {{- end }}
  {{- end }}
  {{- end }}
  {{- if eq .Method "GET" }}
  const queryParams = { ...params } as any;
  {{- range $argList }}
  delete queryParams.{{ . }};
  {{- if ne . (JSONName .) }}
  delete queryParams.{{ JSONName . }};
  {{- end }}
  {{- end }}
  return apiClient.get<Types.{{ .RPC }}Response>(`{{ PathTemplate .Path }}`, { params: queryParams }).then((r) =>
    validateResponse('{{ .RPC }}ResponseSchema', r.data, '{{ .RPC }}')
  );
  {{- else if eq .Method "DELETE" }}
  return apiClient.delete<Types.{{ .RPC }}Response>(`{{ PathTemplate .Path }}`, { data: params }).then((r) => {
    const data = validateResponse('{{ .RPC }}ResponseSchema', r.data, '{{ .RPC }}');
    {{- $targets := MutationInvalidateTargets . }}
    {{- if gt (len $targets) 0 }}
    const invalidateTargets = endpointMeta.{{ LowerFirst .RPC }}.invalidateTargets || [];
    if (invalidateTargets.length > 0) {
      markInvalidateTargets(invalidateTargets, params);
    }
    {{- end }}
    return data;
  });
  {{- else }}
  return apiClient.{{ .Method | ToLower }}<Types.{{ .RPC }}Response>(`{{ PathTemplate .Path }}`, params).then((r) => {
    const data = validateResponse('{{ .RPC }}ResponseSchema', r.data, '{{ .RPC }}');
    {{- $targets := MutationInvalidateTargets . }}
    {{- if gt (len $targets) 0 }}
    const invalidateTargets = endpointMeta.{{ LowerFirst .RPC }}.invalidateTargets || [];
    if (invalidateTargets.length > 0) {
      markInvalidateTargets(invalidateTargets, params);
    }
    {{- end }}
    return data;
  });
  {{- end }}
};

{{- end }}
{{- end }}

export const endpointMeta: Record<string, {
  method: string;
  path: string;
  idempotent?: boolean;
  timeout?: string;
  authRoles?: string[];
  cacheTTL?: string;
  rateLimit?: {
    rps: number;
    burst: number;
  };
  requiredHeaders?: string[];
  retryStrategy?: {
    maxAttempts: number;
    baseDelayMs: number;
    retryOnStatuses: number[];
    retryNetworkErrors: boolean;
  };
  invalidateTargets?: {
    store: string;
    scopeParam?: string;
    mode?: 'list' | 'detail' | 'aggregate';
  }[];
}> = {
{{- range .Endpoints }}
{{- if ne .Method "WS" }}
  {{- $policy := EndpointPolicy . }}
  {{ LowerFirst .RPC }}: {
    method: '{{ .Method }}',
    path: '{{ .Path }}',
    {{- if $policy.Idempotency }}
    idempotent: true,
    {{- end }}
    {{- if $policy.Timeout }}
    timeout: '{{ $policy.Timeout }}',
    {{- end }}
    {{- if $policy.AuthRoles }}
    authRoles: [{{- range $i, $r := $policy.AuthRoles }}{{ if $i }}, {{ end }}'{{ $r }}'{{- end }}],
    {{- end }}
    {{- if $policy.CacheTTL }}
    cacheTTL: '{{ $policy.CacheTTL }}',
    {{- end }}
    {{- if $policy.RateLimit }}
    rateLimit: {
      rps: {{ $policy.RateLimit.RPS }},
      burst: {{ $policy.RateLimit.Burst }},
    },
    {{- end }}
    {{- if $policy.Validation.RequiredHeaders }}
    requiredHeaders: [{{- range $i, $h := $policy.Validation.RequiredHeaders }}{{ if $i }}, {{ end }}'{{ $h }}'{{- end }}],
    {{- end }}
    {{- if $policy.Retry.Enabled }}
    retryStrategy: {
      maxAttempts: {{ $policy.Retry.MaxAttempts }},
      baseDelayMs: {{ $policy.Retry.BaseDelayMS }},
      retryOnStatuses: [{{- range $i, $s := $policy.Retry.RetryOnStatuses }}{{ if $i }}, {{ end }}{{ $s }}{{- end }}],
      retryNetworkErrors: {{ $policy.Retry.RetryNetworkErrors }},
    },
    {{- end }}
    {{- $targets := MutationInvalidateTargets . }}
    {{- if gt (len $targets) 0 }}
    invalidateTargets: [
      {{- range $i, $t := $targets }}
      {{- if $i }},{{ end }}{ store: '{{ $t.Store }}'{{ if $t.ScopeParam }}, scopeParam: '{{ $t.ScopeParam }}'{{ end }}{{ if $t.Mode }}, mode: '{{ $t.Mode }}'{{ end }} }
      {{- end }}
    ],
    {{- end }}
  },
{{- end }}
{{- end }}
};
