// Generated by ANG. Do not edit.
import { Suspense, useState } from 'react';
import { useParams } from 'react-router';
import { Box, Button, Dialog, DialogContent, DialogTitle, Stack, Typography, CircularProgress } from '@mui/material';
import { useQueryClient } from '@tanstack/react-query';
import { FormRenderer } from '@sdk/components/forms';
import { adminEntitiesMap, AdminEntityConfig } from './adminConfig';

function EntityNotFound({ entity }: { entity: string }) {
  return (
    <Box p={4}>
      <Typography color="error">Entity "{entity}" not found in admin config</Typography>
    </Box>
  );
}

function LoadingFallback() {
  return (
    <Box display="flex" justifyContent="center" alignItems="center" minHeight={200}>
      <CircularProgress />
    </Box>
  );
}

export default function AdminPage() {
  const { entity } = useParams<{ entity: string }>();
  const config = entity ? adminEntitiesMap[entity] : undefined;

  if (!config) {
    return <EntityNotFound entity={entity || 'unknown'} />;
  }

  return <AdminEntityPage config={config} />;
}

function AdminEntityPage({ config }: { config: AdminEntityConfig }) {
  const queryClient = useQueryClient();
  const [createOpen, setCreateOpen] = useState(false);
  const [editRow, setEditRow] = useState<any | null>(null);

  const invalidateList = () => {
    queryClient.invalidateQueries({ queryKey: config.listQueryKey });
  };

  const { TableComponent } = config;

  return (
    <Box p={3}>
      <Stack direction="row" spacing={2} alignItems="center" justifyContent="space-between" mb={3}>
        <Typography variant="h4">{config.title}</Typography>
        {config.createFormName && (
          <Button variant="contained" onClick={() => setCreateOpen(true)}>
            Создать
          </Button>
        )}
      </Stack>

      <Suspense fallback={<LoadingFallback />}>
        <TableComponent
          onEdit={config.updateFormName ? (row: any) => setEditRow(row) : undefined}
        />
      </Suspense>

      {config.createFormName && (
        <Dialog open={createOpen} onClose={() => setCreateOpen(false)} fullWidth maxWidth="md">
          <DialogTitle>Создать {config.title}</DialogTitle>
          <DialogContent>
            <FormRenderer
              formName={config.createFormName as any}
              onSuccess={() => {
                setCreateOpen(false);
                invalidateList();
              }}
              onCancel={() => setCreateOpen(false)}
            />
          </DialogContent>
        </Dialog>
      )}

      {config.updateFormName && (
        <Dialog open={!!editRow} onClose={() => setEditRow(null)} fullWidth maxWidth="md">
          <DialogTitle>Редактировать {config.title}</DialogTitle>
          <DialogContent>
            {editRow && (
              <FormRenderer
                formName={config.updateFormName as any}
                defaultValues={config.updateIdField ? { ...editRow, [config.updateIdField]: editRow.id } : editRow}
                onSuccess={() => {
                  setEditRow(null);
                  invalidateList();
                }}
                onCancel={() => setEditRow(null)}
              />
            )}
          </DialogContent>
        </Dialog>
      )}
    </Box>
  );
}
