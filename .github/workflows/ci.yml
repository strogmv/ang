name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  go:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build ANG CLI
        run: go build ./cmd/ang

      - name: Run Compiler Tests
        run: go test ./compiler/... ./cmd/ang

      - name: Validate Intent
        run: go run ./cmd/ang validate

  release-gates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Python Template Freeze Check
        run: |
          git fetch origin main --depth=1
          ./scripts/check_python_template_freeze.sh origin/main

      - name: Build Multi-Target (Go + Python)
        env:
          ANG_PY_SDK: "1"
        run: go run ./cmd/ang build

      - name: Determinism Check (second build, same outputs)
        env:
          ANG_PY_SDK: "1"
        run: |
          rm -rf dist
          go run ./cmd/ang build
          find dist/release -type f -print0 | sort -z | xargs -0 sha256sum > /tmp/ang-release-hash-1.txt
          go run ./cmd/ang build
          find dist/release -type f -print0 | sort -z | xargs -0 sha256sum > /tmp/ang-release-hash-2.txt
          diff -u /tmp/ang-release-hash-1.txt /tmp/ang-release-hash-2.txt

      - name: Artifact Presence Smoke
        run: |
          test -f dist/release/go-service/cmd/server/main.go
          test -f dist/release/python-service/app/main.py
          test -f dist/release/go-service/sdk/python/pyproject.toml

      - name: Python SDK Smoke (install + import)
        run: |
          python -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install -e dist/release/go-service/sdk/python
          python -c "from ang_sdk import AngClient; print('ok')"

      - name: FastAPI Scaffold Smoke (py_compile)
        run: |
          test -f dist/release/python-service/app/main.py
          test -f dist/release/python-service/app/routers/auth.py
          test -f dist/release/python-service/app/services/auth.py
          python -m py_compile \
            dist/release/python-service/app/main.py \
            dist/release/python-service/app/routers/auth.py \
            dist/release/python-service/app/services/auth.py

      - name: PDF Example Smoke (from CUE)
        run: |
          go run ./cmd/ang build examples/pdf-chart-python --target=python
          test -f examples/pdf-chart-python/app/main.py
          test -f examples/pdf-chart-python/app/services/report.py
          python -m py_compile \
            examples/pdf-chart-python/app/main.py \
            examples/pdf-chart-python/app/services/report.py

      - name: OpenAPI Compatibility Report
        run: |
          mkdir -p dist/release/reports
          GO_OAS="dist/release/go-service/api/openapi.yaml"
          PY_OAS="dist/release/python-service/api/openapi.yaml"
          DIFF_FILE="dist/release/reports/openapi-go-vs-python.diff"
          SUMMARY_FILE="dist/release/reports/openapi-go-vs-python.md"

          GO_SHA="$(sha256sum "$GO_OAS" | awk '{print $1}')"
          PY_SHA="$(sha256sum "$PY_OAS" | awk '{print $1}')"
          if diff -u "$GO_OAS" "$PY_OAS" >"$DIFF_FILE"; then
            STATUS="identical"
          else
            STATUS="different"
          fi

          cat >"$SUMMARY_FILE" <<EOF
          # OpenAPI Compatibility Report
          - Go sha256: \`$GO_SHA\`
          - Python sha256: \`$PY_SHA\`
          - Status: **$STATUS**
          - Diff: \`$DIFF_FILE\`
          EOF

      - name: Upload Release Reports
        uses: actions/upload-artifact@v4
        with:
          name: release-reports
          path: dist/release/reports
