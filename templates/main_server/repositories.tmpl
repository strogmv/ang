{{ define "main_server_repositories" }}
	{{- $needsPG := or .HasSQL (gt (len (AllUsedRepoEntitiesIR .ServicesIR .EntitiesIR)) 0) }}
	runtimeContainer, err := bootstrap.NewRuntimeContainer(
		ctx,
		cfg,
		{{- if $needsPG }}
		pgPool,
		{{- end }}
		{{- if .HasMongo }}
		mongoClient,
		{{- end }}
		{{- if or .HasCache (or (eq .AuthRefreshStore "redis") (eq .AuthRefreshStore "hybrid")) }}
		redisClient,
		{{- end }}
		natsClient,
		{{- if .HasS3 }}
		s3Client,
		{{- end }}
		{{- if or .HasNotificationsService .HasNotificationDispatch }}
		notificationDispatcher,
		{{- end }}
	)
	if err != nil {
		log.Error("Failed to build runtime container", "error", err)
		os.Exit(1)
	}

	{{- if and .AuthService (HasEntityByNameIR .EntitiesIR "User") }}
	transport.SetVerifiedUserChecker(func(ctx context.Context, userID string) (bool, error) {
		if strings.TrimSpace(userID) == "" {
			return false, nil
		}
		u, err := runtimeContainer.RepoUser.FindByID(ctx, userID)
		if err != nil {
			return false, err
		}
		if u == nil {
			return false, nil
		}
		return strings.EqualFold(strings.TrimSpace(u.Status), "active"), nil
	})
	{{- end }}

	{{- if and .NotificationMuting (or .HasNotificationsService .HasNotificationDispatch) (HasEntityByNameIR .EntitiesIR "User") }}
	notificationDispatcher.UserMuteChecker = func(ctx context.Context, userID string, msg port.NotificationMessage) (bool, error) {
		user, err := runtimeContainer.RepoUser.FindByID(ctx, userID)
		if err != nil {
			return false, err
		}
		if user == nil {
			return false, nil
		}
		muteType := strings.TrimSpace(msg.MuteKey)
		if muteType == "" {
			muteType = strings.TrimSpace(msg.Type)
		}
		return adapter.IsNotificationMuted(user, muteType), nil
	}
	{{- end }}
{{ end }}
