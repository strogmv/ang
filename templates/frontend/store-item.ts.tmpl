// Generated by ANG. Do not edit.
import { create } from 'zustand';
import type * as Types from '../types';
import { registerStoreInvalidator } from './invalidation';

{{- $ent := .Entity }}
{{- if EntityHasID $ent }}
type {{ $ent.Name }}Id = Types.{{ $ent.Name }}['{{ ToLower (EntityIDFieldName $ent) }}'];

const {{ LowerFirst $ent.Name }}IdKey = (item: Types.{{ $ent.Name }}): string =>
  String(item.{{ ToLower (EntityIDFieldName $ent) }});

export interface {{ $ent.Name }}Store {
  items: Record<string, Types.{{ $ent.Name }}>;
  list: Types.{{ $ent.Name }}[];
  listStale: boolean;
  detailStale: Record<string, boolean>;
  listVersion: number;
  setAll: (items: Types.{{ $ent.Name }}[]) => void;
  upsert: (item: Types.{{ $ent.Name }}) => void;
  remove: (id: {{ $ent.Name }}Id) => void;
  markListStale: () => void;
  markDetailStale: (id: {{ $ent.Name }}Id) => void;
  clearListStale: () => void;
  clearDetailStale: (id: {{ $ent.Name }}Id) => void;
  clear: () => void;
}

export const use{{ $ent.Name }}Store = create<{{ $ent.Name }}Store>()((set) => ({
  items: {},
  list: [],
  listStale: false,
  detailStale: {},
  listVersion: 0,
  setAll: (items) => {
    const index: Record<string, Types.{{ $ent.Name }}> = {};
    for (const item of items) {
      index[{{ LowerFirst $ent.Name }}IdKey(item)] = item;
    }
    set((state) => ({ items: index, list: items, listStale: false, detailStale: {}, listVersion: state.listVersion + 1 }));
  },
  upsert: (item) =>
    set((state) => {
      const key = {{ LowerFirst $ent.Name }}IdKey(item);
      const items = { ...state.items, [key]: item };
      const exists = state.list.some((entry) => {{ LowerFirst $ent.Name }}IdKey(entry) === key);
      const list = exists
        ? state.list.map((entry) => ({{ LowerFirst $ent.Name }}IdKey(entry) === key ? item : entry))
        : [item, ...state.list];
      const detailStale = { ...state.detailStale, [key]: false };
      return { items, list, listStale: false, detailStale, listVersion: state.listVersion + 1 };
    }),
  remove: (id) =>
    set((state) => {
      const key = String(id);
      if (!state.items[key]) {
        return state;
      }
      const items = { ...state.items };
      delete items[key];
      const list = state.list.filter((entry) => {{ LowerFirst $ent.Name }}IdKey(entry) !== key);
      const detailStale = { ...state.detailStale };
      delete detailStale[key];
      return { items, list, listStale: false, detailStale, listVersion: state.listVersion + 1 };
    }),
  markListStale: () =>
    set((state) => {
      if (state.listStale) return state;
      return { listStale: true, listVersion: state.listVersion + 1 };
    }),
  markDetailStale: (id) =>
    set((state) => {
      const key = String(id);
      if (state.detailStale[key]) return state;
      return { detailStale: { ...state.detailStale, [key]: true }, listVersion: state.listVersion + 1 };
    }),
  clearListStale: () => set({ listStale: false }),
  clearDetailStale: (id) =>
    set((state) => {
      const key = String(id);
      if (!state.detailStale[key]) return state;
      const next = { ...state.detailStale };
      delete next[key];
      return { detailStale: next };
    }),
  clear: () => set((state) => ({ items: {}, list: [], listStale: false, detailStale: {}, listVersion: state.listVersion + 1 })),
}));

registerStoreInvalidator('{{ ToLower $ent.Name }}', (target, params) => {
  const state = use{{ $ent.Name }}Store.getState();
  if (target?.mode === 'detail' && target.scopeParam && params && typeof params === 'object') {
    const obj = params as Record<string, unknown>;
    const raw = obj[target.scopeParam];
    if (raw !== undefined && raw !== null && raw !== '') {
      state.markDetailStale(raw as {{ $ent.Name }}Id);
      return;
    }
  }
  state.markListStale();
});
{{- end }}
