// ============================================================================
// AUTO-GENERATED by ANG (Architectural Normalized Generator)
// Version: {{ ANGVersion }}
// InputHash: {{ InputHash }}
// CompilerHash: {{ CompilerHash }}
// DO NOT EDIT - changes will be overwritten on next generation
// GENERATED: true
// ============================================================================

// Package domain contains domain entities and business logic.
package domain

import (
	"fmt"
{{- range .Imports }}
	"{{ . }}"
{{- end }}
)

// {{ ExportName .Name }} represents the domain entity.
{{- if .Source }}
// Source: {{ .Source }}
{{- end }}
type {{ ExportName .Name }} struct {
	{{- range .Fields }}
	{{- if not .SkipDomain }}
	{{- if .Source }}
	// Source: {{ .Source }}
	{{- end }}
	{{ ExportName .Name }} {{ GoType .Type | TrimDomain }} `json:"{{ JSONName .Name }}"`
	{{- end }}
	{{- end }}
}

func (e *{{ ExportName .Name }}) Validate() error {
	{{- range .Fields }}
	{{- if and (not .SkipDomain) .Constraints }}
	{{- if .Constraints.Min }}
	if e.{{ ExportName .Name }} < {{ .Constraints.Min }} {
		return fmt.Errorf("field {{ JSONName .Name }} must be >= %v", {{ .Constraints.Min }})
	}
	{{- end }}
	{{- if .Constraints.Max }}
	if e.{{ ExportName .Name }} > {{ .Constraints.Max }} {
		return fmt.Errorf("field {{ JSONName .Name }} must be <= %v", {{ .Constraints.Max }})
	}
	{{- end }}
	{{- if .Constraints.MinLen }}
	if len(e.{{ ExportName .Name }}) < {{ .Constraints.MinLen }} {
		return fmt.Errorf("field {{ JSONName .Name }} length must be >= %v", {{ .Constraints.MinLen }})
	}
	{{- end }}
	{{- if .Constraints.MaxLen }}
	if len(e.{{ ExportName .Name }}) > {{ .Constraints.MaxLen }} {
		return fmt.Errorf("field {{ JSONName .Name }} length must be <= %v", {{ .Constraints.MaxLen }})
	}
	{{- end }}
	{{- if .Constraints.Enum }}
	{
		valid := false
		allowed := []string{ {{- range $i, $v := .Constraints.Enum }}{{ if $i }}, {{ end }}"{{ $v }}"{{ end }} }
		for _, v := range allowed {
			if e.{{ ExportName .Name }} == v {
				valid = true
				break
			}
		}
		if !valid {
			return fmt.Errorf("field {{ JSONName .Name }} must be one of %v", allowed)
		}
	}
	{{- end }}
	{{- end }}
	{{- end }}
	return nil
}

// LogValue implements slog.LogValuer interface.
// It automatically masks fields marked as @secret or @pii.
func (e *{{ ExportName .Name }}) LogValue() slog.Value {
	return slog.GroupValue(
		{{- range .Fields }}
		{{- if not .SkipDomain }}
		{{- if .IsSecret }}
		slog.String("{{ JSONName .Name }}", "***"),
		{{- else if .IsPII }}
		slog.String("{{ JSONName .Name }}", "[PII]"), // In future we can add masking logic like e***l@...
		{{- else }}
		slog.Any("{{ JSONName .Name }}", e.{{ ExportName .Name }}),
		{{- end }}
		{{- end }}
		{{- end }}
	)
}

{{- range .Fields }}
{{- if or (eq .Name "status") (hasSuffix .Name "Status") }}
const (
	{{ ExportName $.Name }}StatusApproved = "approved"
	{{ ExportName $.Name }}StatusPending = "pending"
	{{ ExportName $.Name }}StatusRejected = "rejected"
	{{ ExportName $.Name }}StatusFromInvite = "from_invite"
	{{ ExportName $.Name }}StatusInProgress = "in_progress"
	{{ ExportName $.Name }}StatusLive = "live"
	{{ ExportName $.Name }}StatusClosed = "closed"
)
{{- end }}
{{- end }}

// New{{ ExportName .Name }} creates a new instance of {{ ExportName .Name }} with default values.
func New{{ ExportName .Name }}() *{{ ExportName .Name }} {
	return &{{ ExportName .Name }}{
		{{- range .Fields }}
		{{- if .Default }}
		{{ .Name | ExportName }}: {{ .Default }},
		{{- end }}
		{{- end }}
	}
}

{{- if .FSM }}
// CanTransitionTo checks if the state transition is allowed.
func (e *{{ ExportName .Name }}) CanTransitionTo(target string) bool {
	switch e.{{ .FSM.Field | ExportName }} {
	{{- range $from := sortedKeys .FSM.Transitions }}
	{{- $tos := index $.FSM.Transitions $from }}
	case "{{ $from }}":
		{{- if $tos }}
		return {{ range $i, $to := $tos }}{{ if $i }} || {{ end }}target == "{{ $to }}"{{ end }}
		{{- else }}
		return false
		{{- end }}
	{{- end }}
	}
	return false
}

// TransitionTo performs the state transition.
func (e *{{ ExportName .Name }}) TransitionTo(target string) error {
	if !e.CanTransitionTo(target) {
		return fmt.Errorf("invalid transition from %s to %s", e.{{ .FSM.Field | ExportName }}, target)
	}
	e.{{ .FSM.Field | ExportName }} = target
	return nil
}
{{- end }}

{{- range .Fields }}
{{- $hasFile := false }}
{{- range .Attributes }}{{ if or (eq .Name "file") (eq .Name "image") }}{{ $hasFile = true }}{{ end }}{{ end }}
{{- if $hasFile }}
// {{ .Name | ExportName }}Preview returns a URL for the file preview.
func (e *{{ ExportName $.Name }}) {{ .Name | ExportName }}Preview(w, h int) string {
	if e.{{ .Name | ExportName }} == "" {
		return ""
	}
	// For PDF, imgproxy will automatically take the first page
	return fmt.Sprintf("/proxy/resize:fill:%d:%d/plain/%s", w, h, e.{{ .Name | ExportName }})
}
{{- end }}
{{- end }}
